---
title: "3-Trips characteristics"
format: html
editor: visual
---

## Plots with LME predictions

Linear mixed models are applied on trip charateristics to test whether individuals change their behaviour over time. Models are fitted on each colony separately.

```{r}
#| echo: false
#| include: true
#| warning: false
#| message: false
library(here)
library(tidyverse)
library(ggplot2)
library(viridis)
library(gridExtra)
library(nlme)
library(emmeans)

source(here("R","trip_functions.R"))

#bassrock for trips
load(here("Data","NewlyCreatedData","loc_clean_interp_bassrock.RData"))
trips.bassrock<-trips_summary_ind(loc.interp.bassrock,colony=colo_coord_bassrock)
#bassrock for nest attendance
load(here("data","NewlyCreatedData","rawLocBassrock.Rdata"))
land.bassrock<-rawLoc.bassrock %>% 
    land_summary_ind(.,colony=colo_coord_bassrock) %>% 
    dplyr::filter(LandDurh > 1) 

#rouzic for trips
load(here("Data","NewlyCreatedData","loc_clean_interp_rouzic.RData"))
trips.rouzic<-trips_summary_ind(loc.interp.rouzic,colony=colo_coord_rouzic)
#rouzic for nest attendance
load(here("data","NewlyCreatedData","rawLocRouzic.Rdata"))
land.rouzic<-rawLoc.rouzic %>% 
    land_summary_ind(.,colony=colo_coord_rouzic) %>% 
    dplyr::filter(LandDurh > 1) 
 
 trips<-trips.bassrock %>% 
        rbind(trips.rouzic) %>% 
       mutate(day=as.numeric(as.Date(DateEnd) - as.Date("2022-08-10")))
 
trips.bassrock<-trips %>% 
    dplyr::filter(site=="Bass Rock")
trips.rouzic<-trips %>% 
     dplyr::filter(site=="Rouzic")


lands<-land.bassrock %>% 
    rbind(land.rouzic ) %>% 
    mutate(day=as.numeric(as.Date(DateEnd) - as.Date("2022-08-10")))

land.bassrock<-lands %>% 
    dplyr::filter(site=="Bass Rock")
land.rouzic<-lands %>% 
     dplyr::filter(site=="Rouzic")


mycol<-mako(2,begin=0.35,end=0.7)


daysx<-c("10/08","20/08","30/08","09/09","19/09","29/09","09/10")
newdatrouz<-expand.grid(site=unique(trips.rouzic$site),
                    day=seq(min(trips.rouzic$day),
                            max(trips.rouzic$day),1))

newdatbass<-expand.grid(site=unique(trips.bassrock$site),
                    day=seq(min(trips.bassrock$day),
                            max(trips.bassrock$day),1))


#plot with separate datasets maximal distance to the colony
glmm.dist.lme.rouzic<-lme(log(Distmaxkm) ~ day, random=~1 | id , data=trips.rouzic)
glmm.dist.rouz<-lmerTest::lmer(log(Distmaxkm) ~ day + (1 | id),data=trips.rouzic)

glmm.dist.lme.bassrock<-lme(log(Distmaxkm) ~ day, random=~1 | id , data=trips.bassrock)
glmm.dist.bass<-lmerTest::lmer(log(Distmaxkm) ~ day + (1 | id),data=trips.bassrock)

summary(glmm.dist.rouz)
summary(glmm.dist.bass)

par(mfrow=c(1,2))
qqnorm(resid(glmm.dist.lme.rouzic))
qqline(resid(glmm.dist.lme.rouzic))

qqnorm(resid(glmm.dist.lme.bassrock))
qqline(resid(glmm.dist.lme.bassrock))

#predict fitted values and CI
newdatrouz$pred<-predict(glmm.dist.lme.rouzic, newdata=newdatrouz,se.fit=T,level=0)
newdatbass$pred<-predict(glmm.dist.lme.bassrock, newdata=newdatbass,level=0)
grouz <- ref_grid(glmm.dist.lme.rouzic, cov.keep= c('day'))
gbass <- ref_grid(glmm.dist.lme.bassrock, cov.keep= c('day'))
emmrouz <- data.frame(emmeans(grouz, spec= c('day'), level= 0.95),
                      site="Rouzic")
emmbass <- data.frame(emmeans(gbass, spec= c('day'), level= 0.95),
                      site="Bass Rock")

newdatall<-rbind(newdatbass,newdatrouz)
emm<-rbind(emmbass,emmrouz)

distgg<-ggplot(trips, aes(x=day, y=Distmaxkm ,colour=site)) + 
geom_point(alpha=0.4) +
 geom_line(data=newdatall,aes(x=day,y=exp(pred)),lwd=2) +
geom_ribbon(data= data.frame(emm), 
            aes(ymin= exp(lower.CL), ymax= exp(upper.CL), y= NULL,fill=site), 
            alpha=0.4,colour = NA) +
     labs(y="Maximal distance to the colony (km)",tag="a)",x="") +
    scale_x_continuous(limits=c(0,64),
                       labels=daysx,
                       breaks=seq(0,64,10),
                       expand=c(0.001,0.05)) +
    scale_y_continuous(limits=c(0,700,100),
                       breaks=seq(0,700,100),
                       expand=c(0.01,0)) + 
    
  scale_colour_manual(values=mycol) +
    scale_fill_manual(values=mycol)  +
    theme(legend.position="none") 
    
print(distgg)

#plot with separate datasets trip duration
glmm.dur.lme.rouzic<-lme(log(TripDurh) ~ day, random=~1 | id , data=trips.rouzic)
glmm.dur.rouz<-lmerTest::lmer(log(TripDurh) ~ day + (1 | id),data=trips.rouzic)
glmm.dur.lme.bassrock<-lme(log(TripDurh) ~ day, random=~1 | id , data=trips.bassrock)
glmm.dur.bass<-lmerTest::lmer(log(TripDurh) ~ day + (1 | id),data=trips.bassrock)

summary(glmm.dur.rouz)
summary(glmm.dur.bass)

par(mfrow=c(1,2))
qqnorm(resid(glmm.dur.lme.rouzic))
qqline(resid(glmm.dur.lme.rouzic))

qqnorm(resid(glmm.dur.lme.bassrock))
qqline(resid(glmm.dur.lme.bassrock))

#predict fitted values and CI
newdatrouz$pred<-predict(glmm.dur.lme.rouzic, newdata=newdatrouz,level=0)
newdatbass$pred<-predict(glmm.dur.lme.bassrock, newdata=newdatbass,level=0)
grouz <- ref_grid(glmm.dur.lme.rouzic, cov.keep= c('day'))
gbass <- ref_grid(glmm.dur.lme.bassrock, cov.keep= c('day'))
emmrouz <- data.frame(emmeans(grouz, spec= c('day'), level= 0.95),
                      site="Rouzic")
emmbass <- data.frame(emmeans(gbass, spec= c('day'), level= 0.95),
                      site="Bass Rock")

newdatall<-rbind(newdatbass,newdatrouz)
emm<-rbind(emmbass,emmrouz)

durgg<-ggplot(trips, aes(x=day, y=TripDurh ,colour=site)) + 
geom_point(alpha=0.4) +
 geom_line(data=newdatall,aes(x=day,y=exp(pred)),lwd=2) +
geom_ribbon(data= data.frame(emm), 
            aes(ymin= exp(lower.CL), ymax= exp(upper.CL), y= NULL,fill=site), 
            alpha=0.4,colour = NA) +
     labs(y="Trip Duration (h)",tag="b)",x="") +
    scale_x_continuous(limits=c(0,64),
                       labels=daysx,
                       breaks=seq(0,64,10),
                       expand=c(0.001,0.01)) +
    scale_y_continuous(limits=c(0,200),
                       breaks=seq(0,200,50),
                       expand=c(0.001,0)) +
    
  scale_colour_manual(values=mycol) +
    scale_fill_manual(values=mycol)  +
    theme(legend.position="none") 
    
print(durgg)



#plot with separate datasets trip duration
glmm.path.lme.rouzic<-lme(log(TotalPathkm) ~ day, random=~1 | id , data=trips.rouzic)
glmm.path.rouz<-lmerTest::lmer(log(TotalPathkm) ~ day + (1 | id),data=trips.rouzic)
glmm.path.lme.bassrock<-lme(log(TotalPathkm) ~ day, random=~1 | id , data=trips.bassrock)
glmm.path.bass<-lmerTest::lmer(log(TotalPathkm) ~ day + (1 | id),data=trips.bassrock)

summary(glmm.path.rouz)
summary(glmm.path.bass)

par(mfrow=c(1,2))
qqnorm(resid(glmm.path.lme.rouzic))
qqline(resid(glmm.path.lme.rouzic))

qqnorm(resid(glmm.path.lme.bassrock))
qqline(resid(glmm.path.lme.bassrock))

#predict fitted values and CI
newdatrouz$pred<-predict(glmm.path.lme.rouzic, newdata=newdatrouz,level=0)
newdatbass$pred<-predict(glmm.path.lme.bassrock, newdata=newdatbass,level=0)
grouz <- ref_grid(glmm.path.lme.rouzic, cov.keep= c('day'))
gbass <- ref_grid(glmm.path.lme.bassrock, cov.keep= c('day'))
emmrouz <- data.frame(emmeans(grouz, spec= c('day'), level= 0.95),
                      site="Rouzic")
emmbass <- data.frame(emmeans(gbass, spec= c('day'), level= 0.95),
                      site="Bass Rock")

newdatall<-rbind(newdatbass,newdatrouz)
emm<-rbind(emmbass,emmrouz)

pathgg<-ggplot(trips, aes(x=day, y=TotalPathkm ,colour=site)) + 
geom_point(alpha=0.4) +
 geom_line(data=newdatall,aes(x=day,y=exp(pred)),lwd=2) +
geom_ribbon(data= emm, 
            aes(ymin= exp(lower.CL), ymax= exp(upper.CL), y= NULL,fill=site), 
            alpha=0.4,colour = NA) +
     labs(y="Total distance travelled (km)",tag="c)",x="") +
    scale_x_continuous(limits=c(0,64),
                       labels=daysx,
                       breaks=seq(0,64,10),
                       expand=c(0.0001,0.01)) +
    scale_y_continuous(limits=c(0,1750),
                       breaks=seq(0,1500,500),
                       expand=c(0.001,0)) +

  scale_colour_manual(values=mycol) +
    scale_fill_manual(values=mycol)  +
    theme(legend.position="none") 
    
print(pathgg)


#plot with separate datasets time spend on land
glmm.land.lme.rouzic<-lme(log(LandDurh) ~ day, random=~1 | id , data=land.rouzic)
glmm.land.rouz<-lmerTest::lmer(log(LandDurh) ~ day + (1 | id),data=land.rouzic)

glmm.land.lme.bassrock<-lme(log(LandDurh) ~ day, random=~1 | id , data=land.bassrock)
glmm.land.bass<-lmerTest::lmer(log(LandDurh) ~ day + (1 | id),data=land.bassrock)

summary(glmm.land.rouz)
summary(glmm.land.bass)

par(mfrow=c(1,2))
qqnorm(resid(glmm.land.lme.rouzic))
qqline(resid(glmm.land.lme.rouzic))

qqnorm(resid(glmm.land.lme.bassrock))
qqline(resid(glmm.land.lme.bassrock))

#predict fitted values and CI
newdatrouz$pred<-predict(glmm.land.lme.rouzic, newdata=newdatrouz,level=0)
newdatbass$pred<-predict(glmm.land.lme.bassrock, newdata=newdatbass,level=0)
grouz <- ref_grid(glmm.land.lme.rouzic, cov.keep= c('day'))
gbass <- ref_grid(glmm.land.lme.bassrock, cov.keep= c('day'))
emmrouz <- data.frame(emmeans(grouz, spec= c('day'), level= 0.95),
                      site="Rouzic")
emmbass <- data.frame(emmeans(gbass, spec= c('day'), level= 0.95),
                      site="Bass Rock")

newdatall<-rbind(newdatbass,newdatrouz)
emm<-rbind(emmbass,emmrouz)

durlandgg<-ggplot(lands, aes(x=day, y=LandDurh ,colour=site)) + 
geom_point(alpha=0.4) +
 geom_line(data=newdatall,aes(x=day,y=exp(pred)),lwd=2) +
geom_ribbon(data= data.frame(emm), 
            aes(ymin= exp(lower.CL), ymax= exp(upper.CL), y= NULL,fill=site), 
            alpha=0.4,colour = NA) +
     labs(y="Time attending the colony (h)",tag="d)",x="") +
    scale_x_continuous(limits=c(0,64),
                       labels=daysx,
                       breaks=seq(1,64,10),
                       expand=c(0.0001,0.01)) +
    scale_y_continuous(limits=c(0,60),
                       breaks=seq(0,60,10),
                       expand=c(0.001,0)) +

  scale_colour_manual(values=mycol,name="Colony") +
    scale_fill_manual(values=mycol,name="Colony")  
    
    
print(durlandgg)

mylegend<-g_legend(durlandgg)

tiff(here("outputs","Figure_LMM_trips.tif"),width=7000,height=4000,res=600,
     compression="lzw")
grid.arrange(arrangeGrob(distgg,durgg,pathgg,
                         durlandgg+ theme(legend.position="none") ,
                                     ncol=2),
               mylegend, ncol=2,widths=c(1,0.1)) 

    dev.off()      
```
