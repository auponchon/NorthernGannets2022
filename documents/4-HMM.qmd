---
title: "4-HMM"
format: html
editor: visual
---

## Fitting a HMM

```{r}
library(moveHMM)
library(tidyverse)

load("~/Projects/Northern_gannets_Rouzic_2022/GannetsRouzic2022/data/NewlyCreatedData/loc_clean_interp_bassrock.RData")

load("~/Projects/Northern_gannets_Rouzic_2022/GannetsRouzic2022/data/NewlyCreatedData/loc_clean_interp_rouzic.RData")

dat<-loc.interp.bassrock %>% 
    rbind(loc.interp.rouzic) %>% 
    rename(ID=id)

proc.dat<-prepData(dat,type="LL",coordNames = c("long","lat"))

par(mfrow=c(1,2))
hist(proc.dat$step)
hist(proc.dat$angle)

#finding the right set of parameters for step length and turning angles  for 3 states
 set.seed(12345)
 nruns<-15
 mles<-vector("numeric",length=nruns)

 #test for von mise distribution for angle concentrations
# for (foo in 1:nruns){
#   print(foo)
#   mu0<-sort(c(runif(1,0.05,2),runif(1,0.5,5),runif(1,2,20)) ) # means for step length
#   sigma0<-c(runif(1,0,0.5),runif(1,0.1,5),runif(1,1,10))  #sd for step length
# #  zeromass0<-runif(3,0,0.01)
#   stepPar0<-c(mu0,sigma0)#,zeromass0)  #joint object for step length
#   angleMean0<-sample(c(0,pi),size=3,replace=T)   #mean for turning angle
#   kappa0<-runif(3,0,5)  # angle concentration
#   anglePar0<-c(angleMean0,kappa0)
# 
#   print(c(stepPar0,anglePar0))
# 
#   m0<-fitHMM(data=proc.dat,nbStates=3,stepPar0=stepPar0,anglePar0=anglePar0,
#              formula=~1,angleDist="vm")
#   mles[foo]<--m0$mod$minimum
# 
#   print( mles[foo])
# }
# 
# table(round(mles))

#lowest likelihood: -49995.34 with von mise with rouzic and bass rock separatele
 mu0<-c(1.8653493, 4.1429725, 9.8375791)
sigma0<-c(0.1780091, 2.6315102 ,6.8705592)
 stepPar0<-c(mu0,sigma0)
angleMean0<-c(0,0,pi)
kappa0<-c(4.5767898 ,1.2674079, 2.0306179)
  anglePar0<-c(angleMean0,kappa0)

  mvm<-fitHMM(data=proc.dat,nbStates=3,stepPar0=stepPar0,anglePar0=anglePar0,
             formula=~1,angleDist="vm")
-mvm$mod$minimum

  plotPR(mvm)
  plot(mvm)
  
 

```
